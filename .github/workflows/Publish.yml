name: Publish pytexmk ğŸ  # å®šä¹‰å·¥ä½œæµçš„åç§°ï¼Œå½“æ¨é€åŒ¹é…çš„æ ‡ç­¾æ—¶å‘å¸ƒåˆ°PyPI
on:
  push:
    tags:
      - v*  # å½“æ¨é€ä»¥vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘æ­¤å·¥ä½œæµ

jobs:
  build:
    name: Build PyTeXMK  # å®šä¹‰æ„å»ºä½œä¸šçš„åç§°
    runs-on: ubuntu-latest  # æŒ‡å®šè¿è¡Œæ­¤ä½œä¸šçš„æ“ä½œç³»ç»Ÿ

    steps:
    - name: Checkout source  # æ£€å‡ºæºä»£ç çš„æ­¥éª¤
      uses: actions/checkout@v4  # ä½¿ç”¨actions/checkoutåŠ¨ä½œæ¥æ£€å‡ºä»£ç 

    - name: Set up ğŸ Python  # è®¾ç½®Pythonç¯å¢ƒçš„æ­¥éª¤
      uses: actions/setup-python@v5  # ä½¿ç”¨actions/setup-pythonåŠ¨ä½œæ¥è®¾ç½®Pythonç¯å¢ƒ
      with:
        python-version: "3.x"  # æŒ‡å®šPythonç‰ˆæœ¬ä¸º3.x

    - name: Build ğŸ“¦ source and wheel  # æ„å»ºæºä»£ç å’ŒwheelåŒ…çš„æ­¥éª¤
      run: |
        python3 -m pip install --upgrade build twine rich  # å®‰è£…æ„å»ºå’Œä¸Šä¼ æ‰€éœ€çš„å·¥å…·
        python3 -m build  # æ„å»ºæºä»£ç å’ŒwheelåŒ…

    - name: Store the distribution packages  # å­˜å‚¨æ„å»ºå¥½çš„åˆ†å‘åŒ…çš„æ­¥éª¤
      uses: actions/upload-artifact@v4  # ä½¿ç”¨actions/upload-artifactåŠ¨ä½œæ¥ä¸Šä¼ æ„å»ºå¥½çš„åŒ…
      with:
        name: python-package-distributions  # æŒ‡å®šä¸Šä¼ çš„artifactåç§°
        path: |
          dist/
          CHANGELOG.md


  publish-to-pypi:
    name: Publish ğŸ PyTeXMK ğŸ“¦ to PyPI  # å®šä¹‰å‘å¸ƒåˆ°PyPIä½œä¸šçš„åç§°
    if: startsWith(github.ref, 'refs/tags/')  # åªæœ‰åœ¨æ¨é€æ ‡ç­¾æ—¶æ‰æ‰§è¡Œæ­¤ä½œä¸š
    needs: build  # æŒ‡å®šæ­¤ä½œä¸šä¾èµ–äºbuildä½œä¸š
    runs-on: ubuntu-latest  # æŒ‡å®šè¿è¡Œæ­¤ä½œä¸šçš„æ“ä½œç³»ç»Ÿ
    environment:
      name: pypi  # å®šä¹‰ç¯å¢ƒåç§°
      url: https://pypi.org/project/pytexmk  # æ›¿æ¢ä¸ºå®é™…çš„PyPIé¡¹ç›®URL
    permissions:
      contents: read  # éœ€è¦è¯»å–å†…å®¹çš„æƒé™
      id-token: write  # éœ€è¦å†™å…¥IDä»¤ç‰Œçš„æƒé™

    steps:
    - name: Download all the ğŸ“¦ dists  # ä¸‹è½½æ‰€æœ‰åˆ†å‘åŒ…çš„æ­¥éª¤
      uses: actions/download-artifact@v4  # ä½¿ç”¨actions/download-artifactåŠ¨ä½œæ¥ä¸‹è½½æ„å»ºå¥½çš„åŒ…
      with:
        name: python-package-distributions  # æŒ‡å®šè¦ä¸‹è½½çš„artifactåç§°
        path: ls -R  # æŒ‡å®šä¸‹è½½åˆ°çš„è·¯å¾„

    - name: Publish ğŸ“¦ to PyPI  # å‘å¸ƒåˆ†å‘åŒ…åˆ°PyPIçš„æ­¥éª¤
      uses: pypa/gh-action-pypi-publish@release/v1  # ä½¿ç”¨pypa/gh-action-pypi-publishåŠ¨ä½œæ¥å‘å¸ƒåŒ…
      with:
        repository-url: https://upload.pypi.org/legacy/  # ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„PyPIä¸Šä¼ URL
        packages-dir: dist/
  
  publish-to-github-release:
    name: Publish ğŸ PyTeXMK ğŸ“¦ to GitHub Release  # å®šä¹‰å‘å¸ƒåˆ°GitHub Releaseä½œä¸šçš„åç§°
    if: startsWith(github.ref, 'refs/tags/')  # åªæœ‰åœ¨æ¨é€æ ‡ç­¾æ—¶æ‰æ‰§è¡Œæ­¤ä½œä¸š
    needs: build  # æŒ‡å®šæ­¤ä½œä¸šä¾èµ–äºbuildä½œä¸š
    runs-on: ubuntu-latest  # æŒ‡å®šè¿è¡Œæ­¤ä½œä¸šçš„æ“ä½œç³»ç»Ÿ

    steps:
    - name: Download all the ğŸ“¦ dists  # ä¸‹è½½æ‰€æœ‰åˆ†å‘åŒ…çš„æ­¥éª¤
      uses: actions/download-artifact@v4  # ä½¿ç”¨actions/download-artifactåŠ¨ä½œæ¥ä¸‹è½½æ„å»ºå¥½çš„åŒ…
      with:
        name: python-package-distributions  # æŒ‡å®šè¦ä¸‹è½½çš„artifactåç§°
    - name: Display structure of downloaded files
      run: ls -R

    - name: Extract tag name  # æå–æ ‡ç­¾åç§°çš„æ­¥éª¤
      id: extract_tag
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
      
    - name: Generate Changelog
      run: |
        # è¯»å–CHANGELOG.mdæ–‡ä»¶å†…å®¹
        changelog=$(cat ${{ github.workspace }}/CHANGELOG.md)
        
        # è·å–tag_name
        tag_name=${{ env.TAG_NAME }}
        
        # æŸ¥æ‰¾ä¸tag_nameåŒ¹é…çš„ç‰ˆæœ¬å·ï¼Œå¹¶æå–è¯¥ç‰ˆæœ¬å·ä¸‹çš„æ‰€æœ‰å†…å®¹
        version_header="## $tag_name"
        if [[ $changelog == *"$version_header"* ]]; then
          version_content=$(echo "$changelog" | awk -v version_header="$version_header" '
            /^## / { if (p) exit; p=0 } 
            $0 ~ version_header { p=1; next } 
            p')
          echo "$version_content"
        else
          echo "Version $tag_name not found in CHANGELOG.md"
        fi
        # å°†åŒ¹é…çš„å†…å®¹å†™å…¥æ–°çš„CHANGELOG.mdæ–‡ä»¶
        echo "$version_content" > ${{ github.workspace }}-CHANGELOG.txt

    - name: Publish to GitHub Release  # å‘å¸ƒåˆ°GitHub Releaseçš„æ­¥éª¤
      uses: softprops/action-gh-release@v2.0.8  # ä½¿ç”¨softprops/action-gh-releaseåŠ¨ä½œæ¥å‘å¸ƒåˆ°GitHub Release
      with:
        body_path: ${{ github.workspace }}-CHANGELOG.txt
        token: ${{ secrets.PUBLISH_PYTEXMK }}  # æ›¿æ¢ä¸ºå®é™…çš„GitHub Token
        name: PyTeXMK ${{ github.ref_name }} # 
        files: dist/*  # æŒ‡å®šè¦å‘å¸ƒçš„æ–‡ä»¶è·¯å¾„
